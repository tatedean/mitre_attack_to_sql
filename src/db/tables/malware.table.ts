import db from "../db.js";

export const malwareTable = () => {
  db.exec(`
      CREATE TABLE IF NOT EXISTS malware (
      stix_id TEXT,
      version TEXT,
      matrix_type TEXT,
      external_id TEXT,
      name TEXT,
      description TEXT,
      PRIMARY KEY (stix_id, version, matrix_type)
      );
      CREATE INDEX idx_malware_lookup ON malware (external_id, matrix_type, version);`);

  db.exec(`
      CREATE TABLE IF NOT EXISTS malware_aliases (
      stix_id TEXT,
      version TEXT,
      matrix_type TEXT,
      alias_name TEXT,
      PRIMARY KEY (stix_id, version, matrix_type, alias_name),
      FOREIGN KEY (stix_id, version, matrix_type) 
            REFERENCES malware (stix_id, version, matrix_type) ON DELETE CASCADE
      );
      CREATE INDEX idx_mal_alias_lookup ON malware_aliases (stix_id, version, matrix_type);`);

  db.exec(`
      CREATE TABLE IF NOT EXISTS malware_platforms (
      stix_id TEXT,
      version TEXT,
      matrix_type TEXT,
      platform_name TEXT,
      PRIMARY KEY (stix_id, version, matrix_type, platform_name),
      FOREIGN KEY (stix_id, version, matrix_type) 
            REFERENCES malware (stix_id, version, matrix_type) ON DELETE CASCADE
      );
      CREATE INDEX idx_mal_plat_lookup ON malware_platforms (stix_id, version, matrix_type);`);
};
